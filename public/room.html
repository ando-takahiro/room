<!doctype html>
<html>
  <head>
    <title>learningthree.js boiler plate for three.js</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">

    <script src="vendor/three.js/Three.js"></script>
    <script src="vendor/three.js/Detector.js"></script>
    <!-- https://github.com/mrdoob/stats.js -->
    <script src="vendor/three.js/Stats.js"></script>

    <script src="vendor/jquery-1.7.1.min.js"></script>
    <script src="vendor/Tween.js"></script>
    <script src="vendor/socket.io-client/socket.io.min.js"></script>
    <script src="vendor/underscore-min.js"></script>
    <script src="vendor/mustache.min.js"></script>
    <script src="js/math.js"></script>
    <script src="js/controller.js"></script>
    <script src="js/events.js"></script>

    <link  href="css/main.css" rel="stylesheet"/>
  </head>
  <body>
    <!-- three.js container -->
    <div id="container"></div>

    <script type="text/javascript">

      var stats, scene, renderer, camera, guiEvents = new events.EventEmitter();

      if (!init()) {
        TWEEN.start();
        animate();
      }

      // init the scene
      function init(){
        setupEnv();
        setupGround();
        setupClient();
      }

      // animation loop
      function animate() {
        // loop on request animation loop
        // - it has to be at the begining of the function
        // - see details at http://my.opera.com/emoller/blog/2011/12/20/requestanimationframe-for-smart-er-animating
        requestAnimationFrame(animate);

        // do the render
        render();

        // update stats
        stats.update();
      }

      // render the scene
      function render() {
        // actually render the scene
        renderer.render(scene, camera);
      }

      //
      // logger
      //
      function Logger() {
        this.logs = [];
      }

      Logger.prototype.restore = function(id, dom) {
        this.id = id;
        this.dom = dom;
        this.dom.html('');
        for (var i = 0; i < this.logs.length; i++) {
          this._show(this.logs[i]);
        }
      };

      Logger.prototype._show = function(msg) {
        this.dom.prepend(Mustache.to_html($('#log-template').html(), msg));
      };

      Logger.prototype.push = function(msg) {
        if (typeof msg === 'string') {
          msg = {message: msg};
        } else {
          msg = _.clone(msg);
        }
        _.defaults(msg, {
          date: +new Date(),
          user: this.id
        });

        this.logs.push(msg);

        if (this.dom) {
          this._show(msg);
        }
      };
      
      var _logger = new Logger();
      function log(msg) {
        _logger.push(msg);
      }
      guiEvents.on('hear', function(msg) {
        log(_.extend(msg, {type: 'chat'}));
      });

      //
      // setuppers
      //

      function setupEnv() {
        if (Detector.webgl) {
          renderer = new THREE.WebGLRenderer({
            antialias: true,	// to get smoother output
            preserveDrawingBuffer: true	// to allow screenshot
          });
          renderer.setClearColorHex(0xBBBBBB, 1);
        // uncomment if webgl is required
        //}else{
        //	Detector.addGetWebGLMessage();
        //	return true;
        } else {
          renderer	= new THREE.CanvasRenderer();
        }
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);

        // add Stats.js - https://github.com/mrdoob/stats.js
        stats = new Stats();
        stats.domElement.style.position	= 'absolute';
        stats.domElement.style.bottom	= '0px';
        document.body.appendChild(stats.domElement);

        // create a scene
        scene = new THREE.Scene();

        // put a camera in the scene
        camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 10000);
        camera.position.set(0, 5, 5);
        camera.lookAt(new THREE.Vector3());
        scene.add(camera);
      }

      function setupGround() {
        var geometry = new THREE.PlaneGeometry(100, 100),
            material = new THREE.MeshBasicMaterial({color: 0xFFFFFF}),
            mesh = new THREE.Mesh(geometry, material);

        mesh.rotation.x = -0.5 * Math.PI;
        mesh.position.y = -0.5;
        scene.add(mesh);
      }

      function setupToolbox(entity) {
        var $toolbox = $(Mustache.to_html($('#toolbox-template').html(), {
          avatar: entity.avatar,
          id: entity.id
        }));

        _logger.restore(entity.id, $toolbox.find('#logs'));
        $('body').append($toolbox);
      }

      function setupClient() {
        controller.createClient(io.connect(), localStorage, scene, guiEvents, function(client, localAvatar) {
          setupToolbox(localAvatar.entity);

          var projector = new THREE.Projector();
          $('body').on('click', function(ev) {
            var mouseX = +(ev.clientX / window.innerWidth) * 2 - 1,
                mouseY = -(ev.clientY / window.innerHeight) * 2 + 1,
                vector = new THREE.Vector3(mouseX, mouseY, -1);

            projector.unprojectVector(vector, camera);
            vector.subSelf(camera.position).normalize();

            var moveTo = math.intersectRayAndPlane(
              camera.position, vector,
              math.plane(
                math.v3(0, 0.5, 0), math.v3(0, 1, 0)
              )
            );

            localAvatar.move(moveTo);
            client.move(moveTo);
          });
        });
      }

      //
      // event handlers
      //
      function speak() {
        if (event.keyCode === 10 || event.keyCode === 13) {
          var $this = $(event.target);
          guiEvents.emit('say', $this.val());
          $this.val('');
        }
      }
    </script>

    <script id='toolbox-template' type='text/html'>
      <div id='toolbox' onclick='javascript:event.stopPropagation()'>
        <div class='detail'>{{id}}</div>
        <img id='face' src='{{avatar}}'> </img>
        <span class='triangle-border left'><input type='text' value='hello, everyone' onkeypress='javascript:speak()'></input></span>
        <div id='logs'> </div>
      </div>
    </script>

    <script id='log-template' type='text/html'>
      <p class='detail'>{{message}}</p>
    </script>
  </body>
</html>
